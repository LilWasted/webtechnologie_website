extends layout

block content
  div.w3-container.w3-padding-32
    h1 All Events

      input.w3-input.w3-border.w3-round(type='text', placeholder='Search events...', id='search-bar')
      input.w3-input.w3-border.w3-round(type='text', placeholder='Search by game...', id='game-search-bar')
      div#game-list(style='max-width: 600px; width: 100%; background-color: #fff; display: none; color: black; border-radius: 10px;')
          each game in games
              div.game-item(style='padding: 10px; cursor: pointer;')
                  span= game.name
                  input(type='hidden', value=game._id, class='game-id')
      input.w3-input.w3-border.w3-round(type='date', id='date-search-bar')


    if event_list && event_list.length
      ul(style='list-style-type:none;')
        each event in event_list
          li.w3-padding-16(style='font-size: 1.2rem;')
            a(href=event.url, class='w3-text-blue w3-hover-text-light-blue', style='font-size: 1.5rem;' ) #{event.title}
            p Game: #{event.game.name}
            if event.date
              p Date: #{event.date.toDateString()}
            else
              p Date: Not specified

            if event.status === 'Available'
              p.w3-text-green Available: #{event.participants.length} / #{event.max_size}
            else if event.status === 'Full'
              p.w3-text-red Full: #{event.participants.length} / #{event.max_size}
            else
              p.w3-text-orange #{event.status}
    else
      p.w3-text-gray No events found.

  script(src="/javascripts/scripts.js")
  script.


    // Event listener for selecting a game
    document.addEventListener('click', function (event) {
      const gameList = document.getElementById('game-list');
      const gameInput = document.getElementById('game-search-bar');

      if (event.target.closest('#game-list .game-item')) {
        // Clicked on a dropdown item
        const selectedGame = event.target.closest('.game-item');
        const gameName = selectedGame.querySelector('span').textContent;
        const gameId = selectedGame.querySelector('.game-id').value;

        gameInput.value = gameName; // Set input value to selected game name
        gameInput.dataset.selectedId = gameId; // Store ID in a data attribute for later use

        gameList.style.display = 'none'; // Hide dropdown
      } else if (!event.target.closest('#game-search-bar')) {
        // Hide the dropdown if clicked outside the input or dropdown
        gameList.style.display = 'none';
      }
    });

    // Show dropdown again on input focus
    document.getElementById('game-search-bar').addEventListener('focus', function () {
      const gameList = document.getElementById('game-list');
      if (this.value.trim() !== '') {
        gameList.style.display = 'block';
      }
    });

    function filterEvents() {
      const searchTerm = document.getElementById('search-bar').value.toLowerCase();
      const gameTerm = document.getElementById('game-search-bar').value.toLowerCase();
      const dateTerm = document.getElementById('date-search-bar').value;
      const events = document.querySelectorAll('ul > li');

      events.forEach(event => {
        const title = event.querySelector('a').textContent.toLowerCase();
        const game = event.querySelector('p:nth-of-type(1)').textContent.toLowerCase();
        const date = event.querySelector('p:nth-of-type(2)').textContent;

        const matchesTitle = title.includes(searchTerm);
        const matchesGame = game.includes(gameTerm);
        const matchesDate = dateTerm ? date.includes(new Date(dateTerm).toDateString()) : true;

        if (matchesTitle && matchesGame && matchesDate) {
          event.style.display = '';
        } else {
          event.style.display = 'none';
        }
      });
    }

    document.getElementById('search-bar').addEventListener('input', filterEvents);
    document.getElementById('game-search-bar').addEventListener('input', filterEvents);
    document.getElementById('date-search-bar').addEventListener('input', filterEvents);


    // Show all events when pressing enter on an empty search query
    document.getElementById('game-search-bar').addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && this.value.trim() === '') {
            this.dataset.selectedId = '';
            filterEvents();
        }
    });